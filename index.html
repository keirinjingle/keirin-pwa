<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Keirin Timer</title>
  <link rel="manifest" href="manifest.json" />
  <style>
    body {
      font-family: sans-serif;
      padding: 1rem;
    }
    h1 {
      font-size: 2rem;
      margin-bottom: 1rem;
    }
    .tabs {
      display: flex;
      gap: 1rem;
      margin-bottom: 1rem;
    }
    .tab-button {
      padding: 0.5rem 1rem;
      border: none;
      background-color: #ddd;
      cursor: pointer;
    }
    .tab-button.active {
      background-color: #4caf50;
      color: white;
    }
    .venue-header {
      margin-top: 1rem;
      padding: 0.5rem;
      background-color: #eee;
      font-weight: bold;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .venue-controls {
      display: flex;
      gap: 0.5rem;
    }
    .venue-controls button {
      font-size: 0.8rem;
      padding: 2px 6px;
    }
    .race-container {
      padding-left: 1rem;
      margin-bottom: 1rem;
      border-left: 2px solid #ccc;
      display: none;
    }
    .race-card {
      border-bottom: 1px solid #ccc;
      padding: 0.5rem 0;
    }
    .toggle {
      appearance: none;
      width: 40px;
      height: 24px;
      background: #ccc;
      border-radius: 12px;
      position: relative;
      outline: none;
      cursor: pointer;
      transition: background 0.3s;
    }
    .toggle:checked {
      background: #4caf50;
    }
    .toggle::before {
      content: "";
      position: absolute;
      width: 20px;
      height: 20px;
      top: 2px;
      left: 2px;
      background: white;
      border-radius: 50%;
      transition: transform 0.3s;
    }
    .toggle:checked::before {
      transform: translateX(16px);
    }
    .setting {
      margin-bottom: 1rem;
    }
  </style>
</head>
<body>
  <h1>🚴 Keirin Timer</h1>

  <div class="setting">
    通知タイミング: 
    <select id="notify-minutes">
      <option value="1">1分前</option>
      <option value="2">2分前</option>
      <option value="3">3分前</option>
      <option value="4">4分前</option>
      <option value="5">5分前</option>
    </select>
  </div>

  <div class="tabs">
    <button class="tab-button active" id="tab-all">すべてのレース</button>
    <button class="tab-button" id="tab-on">🔔通知中のレース</button>
  </div>

  <div id="race-list">読み込み中...</div>
<script>
  const today = new Date().toISOString().slice(0, 10).replace(/-/g, "");
  const API_URL = `https://keirinjingle.github.io/date/keirin_race_list_${today}.json`;
  const raceList = document.getElementById("race-list");
  const notifySelect = document.getElementById("notify-minutes");
  const tabAll = document.getElementById("tab-all");
  const tabOn = document.getElementById("tab-on");

  notifySelect.value = localStorage.getItem("notifyMinutes") || "1";
  notifySelect.addEventListener("change", () => {
    localStorage.setItem("notifyMinutes", notifySelect.value);
  });

  let raceData = [];

  fetch(API_URL)
    .then(res => res.json())
    .then(data => {
      raceData = data;
      renderRaces("all");
    });

  function renderRaces(mode = "all") {
    raceList.innerHTML = "";

    raceData.forEach((venueBlock, index) => {
      const venueContainer = document.createElement("div");
      const venueId = `venue-${index}`;

      const venueHeader = document.createElement("div");
      venueHeader.className = "venue-header";
      venueHeader.innerHTML = `
        <span>${venueBlock.venue}（${venueBlock.grade}）</span>
        <div class="venue-controls">
          <button onclick="toggleAll('${venueId}', true)">すべてON</button>
          <button onclick="toggleAll('${venueId}', false)">すべてOFF</button>
        </div>
      `;
      venueContainer.appendChild(venueHeader);

      const raceContainer = document.createElement("div");
      raceContainer.className = "race-container";
      raceContainer.id = venueId;
      venueContainer.appendChild(raceContainer);

      venueHeader.addEventListener("click", e => {
        if (!e.target.closest(".venue-controls")) {
          raceContainer.style.display = raceContainer.style.display === "block" ? "none" : "block";
        }
      });

      venueBlock.races.forEach(race => {
        const deadline = new Date(`${today.slice(0,4)}-${today.slice(4,6)}-${today.slice(6)}T${race.closed_at}`);
        const now = new Date();
        if (now > deadline) return;

        const raceId = `${venueBlock.venue}_${race.race_number}`;
        const isOn = localStorage.getItem(`toggle-${raceId}`) === "on";

        if (mode === "on" && !isOn) return;

        const card = document.createElement("div");
        card.className = "race-card";
        card.innerHTML = `
          <strong>${race.race_number}R - ${race.class_category}</strong><br />
          締切: ${race.closed_at} ／ 発走: ${race.start_time}<br />
          選手: ${race.players.join("、")}<br />
          <label>
            <input type="checkbox" class="toggle" id="toggle-${raceId}">
          </label>
        `;
        raceContainer.appendChild(card);

        const toggle = card.querySelector(`#toggle-${raceId}`);
        toggle.checked = isOn;

        toggle.addEventListener("change", () => {
          if (toggle.checked) {
            localStorage.setItem(`toggle-${raceId}`, "on");
            scheduleNotification(`${venueBlock.venue} 第${race.race_number}R`, race.closed_at, raceId);
          } else {
            localStorage.removeItem(`toggle-${raceId}`);
          }
        });

        if (toggle.checked) {
          scheduleNotification(`${venueBlock.venue} 第${race.race_number}R`, race.closed_at, raceId);
        }
      });

      if (raceContainer.innerHTML.trim() !== "") {
        raceList.appendChild(venueContainer);
      }
    });
  }

  function toggleAll(containerId, turnOn) {
    const container = document.getElementById(containerId);
    const checkboxes = container.querySelectorAll("input[type='checkbox']");
    checkboxes.forEach(cb => {
      const raceId = cb.id.replace("toggle-", "");
      cb.checked = turnOn;
      if (turnOn) {
        localStorage.setItem(`toggle-${raceId}`, "on");
        scheduleNotification(raceId.replace("_", " 第").replace(/$/, "R"), "", raceId);
      } else {
        localStorage.removeItem(`toggle-${raceId}`);
      }
    });
  }

  function scheduleNotification(title, deadline, raceId) {
    Notification.requestPermission().then(permission => {
      if (permission !== "granted") return;

      if (!deadline) return; // 一括ONのときは無視

      const [h, m] = deadline.split(":").map(Number);
      const notifyMinutes = parseInt(localStorage.getItem("notifyMinutes") || "1");
      const now = new Date();
      const target = new Date();
      target.setHours(h);
      target.setMinutes(m - notifyMinutes);
      target.setSeconds(0);

      const diff = target.getTime() - now.getTime();
      if (diff <= 0) return;

      setTimeout(() => {
        new Notification("🚨 締切通知", {
          body: `${title} の締切 ${notifyMinutes}分前です！`,
        });
      }, diff);
    });
  }

  tabAll.addEventListener("click", () => {
    tabAll.classList.add("active");
    tabOn.classList.remove("active");
    renderRaces("all");
  });

  tabOn.addEventListener("click", () => {
    tabOn.classList.add("active");
    tabAll.classList.remove("active");
    renderRaces("on");
  });

  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('./service-worker.js');
  }
</script>
</body>
</html>
